<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Auth | IWLAB Server</title>
    <!-- Bootstrap CSS from CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body>
    {% include "components/header.html" %}
    <div class="container-fluid py-4">
    <h1 class="text-primary">Footage Reference Sample</h1>
    <video id="preview" width="400" height="300" autoplay muted></video>
  <video id="recorded" width="400" height="300" controls></video>
  <br><br>
  <button id="startBtn">Start</button>
  <button id="pauseBtn">Pause</button>
  <button id="resumeBtn">Resume</button>
  <button id="stopBtn">Stop</button>
  <button id="resetBtn">Reset</button>
  <button id="submitBtn">Submit</button>
    </div>
  <script>
    let mediaRecorder;
    let recordedChunks = [];
    let stream;

    const preview = document.getElementById("preview");
    const recordedVideo = document.getElementById("recorded");

    // Get user media
    async function init() {
      stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      preview.srcObject = stream;
    }
    init();

    document.getElementById("startBtn").onclick = () => {
      recordedChunks = [];
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: "video/webm" });
        recordedVideo.src = URL.createObjectURL(blob); // preview WebM locally
      };
      mediaRecorder.start();
      console.log("Recording started");
    };

    document.getElementById("pauseBtn").onclick = () => {
      if (mediaRecorder && mediaRecorder.state === "recording") mediaRecorder.pause();
    };

    document.getElementById("resumeBtn").onclick = () => {
      if (mediaRecorder && mediaRecorder.state === "paused") mediaRecorder.resume();
    };

    document.getElementById("stopBtn").onclick = () => {
      if (mediaRecorder && (mediaRecorder.state === "recording" || mediaRecorder.state === "paused")) mediaRecorder.stop();
    };

    document.getElementById("resetBtn").onclick = () => {
      recordedChunks = [];
      recordedVideo.src = "";
    };

    document.getElementById("submitBtn").onclick = async () => {
      if (recordedChunks.length === 0) return alert("No recording to submit!");
      const blob = new Blob(recordedChunks, { type: "video/webm" });
      const formData = new FormData();
      formData.append("file", blob, "recording.webm");

      const response = await fetch("/upload", {
        method: "POST",
        body: formData
      });

      if (response.ok) {
        const data = await response.json();
        alert("Recording uploaded and converted to MP4!");
        // Automatically play the MP4 from server
        recordedVideo.src = `/uploads/${data.file}`;
        recordedVideo.load();
        recordedVideo.play();
      } else {
        alert("Upload failed.");
      }
    };
  </script>
  </body>
</html>
